<!doctype html>
<html lang="en">
  <head>
    <title>remotestorage tester</title>
    <meta charset="utf-8" />
    <style>
    </style>
  </head>
  <body>
    <p><input type="submit" onclick="test1();" value="1"/></p>
    <p>user address: <input id="userAddress" />
      <input type="submit" onclick="test2();" value="2"/></p>
    <p>storage root: <input id="storageRoot" />
      storage type: <input id="storageType" />
      auth endpoint: <input id="authEndpoint" />
      content type: <input id="contentType" />
      <input type="submit" onclick="test3();" value="3"/>
      <input type="submit" onclick="test4();" value="4"/></p>
    <p>token: <input id="token" />
      scope: <input id="scope" />
      <input type="submit" onclick="test5();" value="5"/></p>
    <p>data: <input id="data" /></p>
  </body>
  <script>
    function val(id, value) {
      if(value) {
        document.getElementById(id).value = value;
      }
      return document.getElementById(id).value;
    }

    function get(url, token, cb) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url);
      if(token) {
        xhr.setRequestHeader('Authorization', 'Bearer '+token);
      }
      xhr.onload = function(e) {
        cb((this.status == 200 ? null : this.status), this.response, this.getAllResponseHeaders());
      }
      xhr.send();
    }
    function getParam(key) {
      var params = window.location.href.match(/^(.*?)#(.*)$/)[2].split('&');
      for(var i=0; i<params.length; i++) {
        var parts = params[i].split('=');
        if(decodeURIComponent(parts[0])==key) {
          return decodeURIComponent(parts[1]);
        }
      } 
    }
    
    function test1() {
      val('userAddress', getParam('remotestorage'));
    }
    function test2() {
      var parts = val('userAddress').split('@');
      get('https://'+parts[1]+'/.well-known/webfinger?resource='+encodeURIComponent('acct:'+parts[0]+'@'+parts[1]),
          null, function(err, data, responseHeaders) {
        console.log(err);
        console.log(data);
        console.log(typeof(responseHeaders));
        var obj = JSON.parse(data);
        for(var i=0; i<obj.links.length; i++) {
          if(obj.links[i].rel == 'remotestorage') {
            val('storageRoot', obj.links[i].href);
            val('storageType', obj.links[i].type);
            val('authEndpoint', obj.links[i].properties['auth-endpoint']);
            val('contentType', responseHeaders['content-type']);
          }
        }
      });
    }
    function test3() {
      window.location = val('authEndpoint')
        + (val('authEndpoint').indexOf('?')==-1?'?':'&')
        + 'response_type=token'
        + '&redirect_uri=' + encodeURIComponent(window.location.href)
        + '&scope=' + encodeURIComponent('root:rw');
    }
    function test4() {
      val('token', getParam('access_token'));
      val('scope', getParam('scope'));
    }
    function test5() {
      get(val('storageRoot')+'/', val('token'), function(err, data) {
        console.log(err);
        console.log(data);
        val('data', data);
      });
    }
  </script>
</html>
